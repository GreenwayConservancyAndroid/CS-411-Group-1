<?php

/*
 * Database Search Prototype -
 * Created by Proj Group 1
 * Updated by Nishi 11/14/14 to always display from DB and added functions.
 */

/*
 * connectSQL - returns SQL connection
 */

function connectSQL(){

//MySQL default credentials
    $servername = "localhost";
    $username = "root";
    $password = "";

// Create connection
    $conn = new mysqli($servername, $username, $password);

// Check connection
    if ($conn->connect_error) {
        die("Connection failed: " . $conn->connect_error);
    }
    echo "Connected successfully";

    return $conn;

}

/*
 * displayGames - searches within DB to display results
 */
function displayGames($searchTerm, $conn)
{
    $searchWild = '%' . $searchTerm . '%'; //add wildcards

    //Search in game cache DB
    $sql = "SELECT name, image, description, aliases FROM `gamecache`.`gamelist` WHERE name LIKE '$searchWild' LIMIT $pageItems OFFSET $nextPage"; //SELECT * does not work
    $result = $conn->query($sql);

    if($result->num_rows > 0) { //if in DB, display

        // output data of each row
        while ($row = $result->fetch_assoc()) {
            echo $row["name"] . "<br>";
            echo "<img src='", $row["image"], "' alt= 'game picture'>" . "<br>";
            echo $row["description"] . "<br>";
            echo $row["aliases"] . "<br>";

        }
    }
    else {
        $found = cacheGames($searchTerm, $conn);

        if ($found) {
            displayGames($searchTerm, $conn);
        }
        else{
            echo "<br> No results found";;
        }
    }
}

function cacheGames ($search, $conn)
{
    $KEY = '21a3347dc2f2f1848aa95e206fe41e2e05fd93c0';     //API Key

    $url = 'http://www.giantbomb.com/api/search/?api_key=' . $KEY . '&format=xml&query=' . $search . '&resources=game';

    $xml = simplexml_load_file($url);

    //print_r($xml); // Printing XML file contents

    $count =0;

    foreach ($xml->results->game as $game) {

        $image = $game->image->thumb_url; // Solves double -> problem

        $sql = "INSERT INTO `gamecache`.`gamelist` (`Name`, `Image`, `Description`, `Aliases`, `Release Date`)
                VALUES ('$game->name','$image', '$game->deck', '$game->aliases', '$game->original_release_date')";
        if ($conn->query($sql) === TRUE) {
            echo "<br> New record created successfully <br>";
            $count++;
        } else {
            echo "Error: " . $sql . "<br>" . $conn->error;
        }

    }
    if ($count > 0) {
        return true;
    }
    else{
        return false;
    }

}

$search = $_POST["search_term"];

echo 'You searched for: ', $search, "<br><br>";

$conn = connectSQL();
displayGames($search, $conn);


//Do with SQL Limit + paging
/*echo "<br>Results displayed : ", $count;
echo "Total results: ", $xml->number_of_total_results, "<br><br>";
*/

/* User input : Next page, call search again?
Keep track of page numbers and make call to the API with "&page=pageNum"
*/

//$lastUpdated = $xml->results->game->date_last_updated; // to store in DB


$conn->close();

?>
